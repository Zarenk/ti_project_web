// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product{
  id Int @id @default(autoincrement())
  name String @unique
  barcode   String?  @unique // Opcional pero √∫nico
  qrCode    String?  @unique // Opcional pero √∫nico
  description String?
  brand String?
  price Float
  priceSell Float?
  status String?
  image String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaci√≥n con Category
  categoryId  Int
  category    Category @relation(fields: [categoryId], references: [id])
  entryDetail EntryDetail[]
  inventory Inventory[]

  specification ProductSpecification?

  // Relaci√≥n con Transfer
  transfers   Transfer[] // Relaci√≥n con el modelo Transfer

  @@index([categoryId])
  @@index([name])
}

model ProductSpecification {
  id         Int      @id @default(autoincrement())
  productId  Int      @unique
  processor  String?
  ram        String?
  storage    String?
  graphics   String?
  screen     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  product    Product  @relation(fields: [productId], references: [id])

  @@index([productId])
}

model Category{
  id Int @id @default(autoincrement())
  name String @unique
  description String?
  status String?
  image String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaci√≥n con Product
  products    Product[]
}

enum UserRole {
  ADMIN
  EMPLOYEE
  CLIENT
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  username  String   @unique
  password  String
  role      UserRole @default(CLIENT) // Enum para roles de usuario
  client    Client?  // Relaci√≥n opcional con el modelo Client
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entrys           Entry[]   // Relaci√≥n con el modelo Entry
  inventoryHistory InventoryHistory[] // Relaci√≥n con el modelo InventoryHistory
  // Relaci√≥n con Sales
  sales            Sales[]
  cashTransactions CashTransaction[] // Relaci√≥n con la tabla de transacciones de caja
  cashClosures     CashClosure[] // Relaci√≥n con la tabla de cierres de caja

  @@index([email])
  @@index([username])
}

model Client{
  id      Int      @id @default(autoincrement())
  userId    Int      @unique
  name    String   
  type String?
  typeNumber String? @unique
  phone String?
  adress String?
  email String? 
  status  String?
  image   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
  // Relaci√≥n con Sales
  sales Sales[] // Relaci√≥n con el modelo Sales
}

model Provider{
  id      Int      @id @default(autoincrement())
  name    String   
  document String?
  documentNumber String?  @unique
  description String?
  phone String?
  adress String?
  email String? 
  website String?
  status  String?
  image   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entrys    Entry[]   // Relaci√≥n con el modelo Entry
}

model Entry {
  id          Int       @id @default(autoincrement())
  storeId     Int       // Almac√©n relacionado con la entrada  
  userId      Int       // Usuario que realiza la entrada
  providerId  Int       // Proveedor relacionado con la entrada
  date        DateTime  @default(now()) // Fecha de la entrada
  description String?   // Descripci√≥n opcional
  tipoMoneda  String?   // Tipo de moneda (e.g., PEN, USD)
  tipoCambioId Int?      // FK a TipoCambio
  pdfUrl      String?
  guiaUrl     String?   // URL del PDF de la gu√≠a de remisi√≥n
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  store       Store     @relation(fields: [storeId], references: [id]) // Relaci√≥n con el modelo Store
  user        User      @relation(fields: [userId], references: [id]) // Relaci√≥n con el modelo User
  provider    Provider  @relation(fields: [providerId], references: [id]) // Relaci√≥n con el modelo Provider
  details     EntryDetail[]

  invoice     Invoice?  @relation // Relaci√≥n 1:1 con Comprobante (sin `fields` ni `references`)
  tipoCambio   TipoCambio? @relation(fields: [tipoCambioId], references: [id])

  shippingGuides ShippingGuide[]

  @@index([storeId])
  @@index([userId])
  @@index([providerId])
  @@index([date])
}

model Invoice {
  id          Int       @id @default(autoincrement())
  entryId     Int       @unique // Clave for√°nea √∫nica para la relaci√≥n 1:1// Relaci√≥n con la entrada
  serie       String   // Serie del comprobante
  nroCorrelativo String // N√∫mero correlativo del comprobante
  tipoComprobante String?   // N√∫mero del comprobante
  tipoMoneda  String?   // Tipo de moneda (e.g., PEN, USD)
  total       Float?    // Total del comprobante
  fechaEmision DateTime? // Fecha de emisi√≥n del comprobante
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  entry       Entry     @relation(fields: [entryId], references: [id], onDelete:  Cascade) // Relaci√≥n con Entry

  @@index([entryId])
}

model Inventory {
  id          Int       @id @default(autoincrement())
  productId   Int       
  storeId     Int  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt 

  InventoryHistory InventoryHistory[] // Relaci√≥n con el modelo InventoryHistory
  storeOnInventory StoreOnInventory[] // Relaci√≥n con la tabla intermedia
  product     Product   @relation(fields: [productId], references: [id])

  entryDetails EntryDetail[] // Relaci√≥n uno-a-muchos con EntryDetail

  @@unique([productId, storeId]) // Clave compuesta
}

model EntryDetail {
  id          Int       @id @default(autoincrement())
  entryId     Int       // Relaci√≥n con la entrada
  productId   Int       // Producto relacionado
  quantity    Int       // Cantidad de productos ingresados
  price       Float     // Precio unitario del producto
  priceInSoles  Float?      // Precio en soles ya congelado
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  inventoryId Int?      // Relaci√≥n con Inventory

  entry       Entry     @relation(fields: [entryId], references: [id], onDelete: Cascade) // Relaci√≥n con el modelo Entry
  product     Product   @relation(fields: [productId], references: [id]) // Relaci√≥n con el modelo Product
  series      EntryDetailSeries[] // Relaci√≥n con las series
  inventory   Inventory? @relation(fields: [inventoryId], references: [id]) // Relaci√≥n con Inventory
  // Relaci√≥n con SalesDetail
  salesDetails SalesDetail[] // Relaci√≥n con el modelo SalesDetail

  @@index([entryId])  
  @@index([productId])
}

model EntryDetailSeries {
  id          Int             @id @default(autoincrement())
  entryDetailId Int
  serial      String          @unique
  status      String   @default("active") // Nuevo campo
  entryDetail EntryDetail     @relation(fields: [entryDetailId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Store{
  id      Int      @id @default(autoincrement())
  name    String   @unique
  description String?
  ruc String?
  phone String?
  adress String?
  email String? 
  website String?
  status  String?
  image   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  storeOnInventory StoreOnInventory[] // Relaci√≥n con la tabla intermedia
  entries   Entry[]   // Relaci√≥n con el modelo Entry

  // Relaci√≥n con Transfer como tienda de origen
  transfersFrom Transfer[] @relation("SourceStore")

  // Relaci√≥n con Transfer como tienda de destino
  transfersTo Transfer[] @relation("DestinationStore")

  // Relaci√≥n con Sales
  sales Sales[] // Relaci√≥n con el modelo Sales
  
  // Relaci√≥n con la tabla de caja
  CashRegister CashRegister[]
}

model StoreOnInventory {
  id          Int       @id @default(autoincrement())
  inventoryId Int
  storeId     Int
  stock       Int       @default(0) // Stock espec√≠fico para esta relaci√≥n
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  inventory   Inventory @relation(fields: [inventoryId], references: [id])
  store       Store     @relation(fields: [storeId], references: [id])
  // Relaci√≥n con SalesDetail
  salesDetails SalesDetail[] // Relaci√≥n con el modelo SalesDetail

  @@index([inventoryId])
  @@index([storeId])
}

model InventoryHistory {
  id          Int       @id @default(autoincrement())
  inventoryId Int       // Relaci√≥n con el inventario
  userId      Int       // Usuario que realiza el cambio
  action      String    // Tipo de acci√≥n: "create", "update", "delete"
  description String?   // Descripci√≥n opcional
  stockChange Int       // Cambio en el stock (positivo o negativo)
  previousStock Int?    // Stock anterior (opcional)
  newStock    Int?      // Stock nuevo (opcional)
  createdAt   DateTime  @default(now()) // Fecha del cambio

  inventory   Inventory @relation(fields: [inventoryId], references: [id])
  user        User      @relation(fields: [userId], references: [id]) // Relaci√≥n con la tabla de usuarios

  @@index([inventoryId])
  @@index([userId])
  @@index([createdAt])
}

model Transfer {
  id                Int       @id @default(autoincrement())
  sourceStoreId     Int       // ID de la tienda de origen
  destinationStoreId Int      // ID de la tienda de destino
  productId         Int       // ID del producto trasladado
  quantity          Int       // Cantidad trasladada
  description       String?   // Descripci√≥n opcional
  createdAt         DateTime  @default(now()) // Fecha del traslado

  // Relaci√≥n con la tabla Store para la tienda de origen
  sourceStore       Store     @relation("SourceStore", fields: [sourceStoreId], references: [id])

  // Relaci√≥n con la tabla Store para la tienda de destino
  destinationStore  Store     @relation("DestinationStore", fields: [destinationStoreId], references: [id])

  // Relaci√≥n con la tabla Product
  product           Product   @relation(fields: [productId], references: [id])

  @@index([sourceStoreId]) // √çndice para optimizar consultas por tienda de origen
  @@index([destinationStoreId]) // √çndice para optimizar consultas por tienda de destino
  @@index([productId]) // √çndice para optimizar consultas por producto 
}

model Sales {
  id          Int       @id @default(autoincrement())
  userId      Int       // Usuario que realiza la venta
  storeId     Int       // Tienda donde se realiza la venta
  clientId    Int       // Cliente asociado a la venta
  total       Float     // Total de la venta
  description String?   // Descripci√≥n opcional
  createdAt   DateTime  @default(now()) // Fecha de la venta
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id]) // Relaci√≥n con el usuario
  store       Store     @relation(fields: [storeId], references: [id]) // Relaci√≥n con la tienda
  client      Client    @relation(fields: [clientId], references: [id]) // Relaci√≥n con el cliente
  salesDetails SalesDetail[] // Relaci√≥n con los detalles de la venta
  invoices InvoiceSales[] // Relaci√≥n con las facturas de venta
  payments      SalePayment[]   // üëà Relaci√≥n con tabla intermedia
  shippingGuides ShippingGuide[]

  @@index([userId])
  @@index([storeId])
  @@index([clientId])
  @@index([createdAt])
}

model PaymentMethod {
  id          Int      @id @default(autoincrement())
  name        String   @unique // Ejemplo: "Visa", "Yape", "Plin", "Efectivo", "Transferencia"
  description String?  // Descripci√≥n opcional del m√©todo de pago
  isActive    Boolean  @default(true) // Indica si el m√©todo de pago est√° habilitado
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  payments    SalePayment[]  // üëà Relaci√≥n con tabla intermedia
  cashTransactionPayments CashTransactionPaymentMethod[] // Relaci√≥n con la tabla intermedia de transacciones de caja
}

model SalePayment {
  id               Int            @id @default(autoincrement())
  salesId           Int
  paymentMethodId  Int
  amount           Float          // üëà Monto pagado con ese m√©todo
  currency         String @default("PEN")        // Tipo de moneda (e.g., PEN, USD)
  transactionId    String?        // ‚úÖ ID de transacci√≥n para rastrear pagos digitales
  referenceNote    String?        // (opcional) para agregar voucher, observaci√≥n, etc.
  sale             Sales          @relation(fields: [salesId], references: [id])
  paymentMethod    PaymentMethod  @relation(fields: [paymentMethodId], references: [id])

  @@index([salesId])
  @@index([paymentMethodId])
}

model SalesDetail {
  id          Int       @id @default(autoincrement())
  salesId      Int       // Relaci√≥n con la venta
  entryDetailId Int          // Relaci√≥n con el detalle de la entrada
  storeOnInventoryId Int // Relaci√≥n con el inventario de la tienda
  productId   Int       // Producto relacionado
  quantity    Int       // Cantidad de productos vendidos
  price       Float     // Precio unitario del producto
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  sale        Sales     @relation(fields: [salesId], references: [id], onDelete: Cascade) // Relaci√≥n con el modelo Sales
  entryDetail EntryDetail @relation(fields: [entryDetailId], references: [id]) // Relaci√≥n con el modelo EntryDetail
  storeOnInventory StoreOnInventory @relation(fields: [storeOnInventoryId], references: [id]) // Relaci√≥n con el inventario de la tienda

  @@index([salesId])
  @@index([productId])
  @@index([entryDetailId])
  @@index([storeOnInventoryId])
}

model InvoiceSales {
  id          Int       @id @default(autoincrement())
  salesId     Int       @unique // Clave for√°nea √∫nica para la relaci√≥n 1:1// Relaci√≥n con la entrada
  serie       String   // Serie del comprobante
  nroCorrelativo String // N√∫mero correlativo del comprobante
  tipoComprobante String   // N√∫mero del comprobante
  tipoMoneda  String?   // Tipo de moneda (e.g., PEN, USD)
  total       Float?    // Total del comprobante
  fechaEmision DateTime? // Fecha de emisi√≥n del comprobante
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  sales       Sales     @relation(fields: [salesId], references: [id], onDelete:  Cascade) // Relaci√≥n con Entry
  @@unique([tipoComprobante, serie, nroCorrelativo]) // Restricci√≥n √∫nica compuesta
}

model TipoCambio {
  id        Int      @id @default(autoincrement())
  fecha     DateTime           // Fecha del tipo de cambio
  moneda    String             // Ej: "USD", "EUR", "CLP"
  valor     Float              // Cu√°nto vale 1 unidad de esa moneda en soles
  createdAt DateTime @default(now())

  entries   Entry[]            // Relaci√≥n con entradas
  @@unique([fecha, moneda])    // Evita duplicados

  @@index([fecha, moneda]) // üöÄ √≠ndice compuesto
}

model CashRegister {
  id             Int              @id @default(autoincrement())
  name           String           @unique
  description    String?
  storeId        Int
  initialBalance Decimal          @default(0.00)
  currentBalance Decimal          @default(0.00)
  status         CashRegisterStatus @default(ACTIVE)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  store          Store            @relation(fields: [storeId], references: [id])
  transactions   CashTransaction[]
  closures       CashClosure[]

  @@map("cash_registers")
}

model CashTransaction {
  id              Int              @id @default(autoincrement())
  cashRegisterId  Int
  type            CashTransactionType
  amount          Decimal
  description     String?
  userId          Int
  createdAt       DateTime         @default(now())

  cashRegister    CashRegister     @relation(fields: [cashRegisterId], references: [id])
  paymentMethods  CashTransactionPaymentMethod[] // Relaci√≥n con la tabla intermedia
  user            User             @relation(fields: [userId], references: [id])

  @@map("cash_transactions")
}

model CashTransactionPaymentMethod {
  id                Int             @id @default(autoincrement())
  cashTransactionId Int
  paymentMethodId   Int            // Hacer que el campo sea opcional

  cashTransaction   CashTransaction @relation(fields: [cashTransactionId], references: [id])
  paymentMethod     PaymentMethod  @relation(fields: [paymentMethodId], references: [id]) // Relaci√≥n opcional
}

model CashClosure {
  id              Int             @id @default(autoincrement())
  cashRegisterId  Int
  userId          Int
  openingBalance  Decimal
  closingBalance  Decimal
  totalIncome     Decimal
  notes           String?
  totalExpense    Decimal
  createdAt       DateTime         @default(now())

  cashRegister    CashRegister     @relation(fields: [cashRegisterId], references: [id])
  user            User             @relation(fields: [userId], references: [id])

  @@map("cash_closures")
}

// Enums
enum CashRegisterStatus {
  ACTIVE
  CLOSED
}

enum CashTransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

model ShippingGuide {
  id              Int      @id @default(autoincrement())
  serie           String
  correlativo     String
  motivoTraslado  String
  fechaTraslado   DateTime
  puntoPartida    String
  puntoLlegada    String

  transportistaTipoDocumento  String
  transportistaNumeroDocumento String
  transportistaRazonSocial     String
  transportistaNumeroPlaca     String

  destinatarioTipoDocumento    String
  destinatarioNumeroDocumento  String
  destinatarioRazonSocial      String

  xmlName        String?
  zipName        String?
  cdrAceptado    Boolean
  cdrCode        String?
  cdrDescription String?

  ventaId        Int?       // si est√° asociada a una venta
  entryId        Int?       // si est√° asociada a una entrada (traslado)

  createdAt      DateTime  @default(now())

  sale           Sales?    @relation(fields: [ventaId], references: [id])
  entry          Entry?    @relation(fields: [entryId], references: [id])
}