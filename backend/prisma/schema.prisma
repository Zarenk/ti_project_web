// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product{
  id Int @id @default(autoincrement())
  name String @unique
  barcode   String?  @unique // Opcional pero Ãºnico
  qrCode    String?  @unique // Opcional pero Ãºnico
  description String?
  brandName String? @map("brand")
  price Float
  priceSell Float?
  status String?
  image String?
  images String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RelaciÃ³n con Brand
  brandId Int?
  brand   Brand? @relation(fields: [brandId], references: [id])

  // RelaciÃ³n con Category
  categoryId  Int
  category    Category @relation(fields: [categoryId], references: [id])
  entryDetail EntryDetail[]
  inventory Inventory[]

  specification ProductSpecification?
  features      ProductFeature[]
  reviews       Review[]
  favorites     Favorite[]

  // RelaciÃ³n con Transfer
  transfers   Transfer[] // RelaciÃ³n con el modelo Transfer

  @@index([categoryId])
  @@index([name])
  @@index([brandId])
}

model ProductSpecification {
  id         Int      @id @default(autoincrement())
  productId  Int      @unique
  processor  String?
  ram        String?
  storage    String?
  graphics   String?
  screen     String?
  resolution String?
  refreshRate String?
  connectivity String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  product    Product  @relation(fields: [productId], references: [id])

  @@index([productId])
}

model ProductFeature {
  id          Int      @id @default(autoincrement())
  productId   Int
  icon        String?
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product     Product  @relation(fields: [productId], references: [id])

  @@index([productId])
}

model Brand {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  logoSvg   String?
  logoPng   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products  Product[]
}

model Category{
  id Int @id @default(autoincrement())
  name String @unique
  description String?
  status String?
  image String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RelaciÃ³n con Product
  products    Product[]
}

enum UserRole {
  ADMIN
  EMPLOYEE
  CLIENT
  GUEST
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  username  String   @unique
  password  String
  role      UserRole @default(CLIENT) // Enum para roles de usuario
  client    Client?  // RelaciÃ³n opcional con el modelo Client
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tokenVersion Int @default(0)

  entrys           Entry[]   // RelaciÃ³n con el modelo Entry
  inventoryHistory InventoryHistory[] // RelaciÃ³n con el modelo InventoryHistory
  // RelaciÃ³n con Sales
  sales            Sales[]
  cashTransactions CashTransaction[] // RelaciÃ³n con la tabla de transacciones de caja
  cashClosures     CashClosure[] // RelaciÃ³n con la tabla de cierres de caja
  reviews       Review[]
  clientMessages ChatMessage[] @relation("ClientMessages")
  sentMessages   ChatMessage[] @relation("SenderMessages")
  favorites     Favorite[]

  @@index([email])
  @@index([username])
}

model Client{
  id      Int      @id @default(autoincrement())
  userId    Int      @unique
  name    String   
  type String?
  typeNumber String? @unique
  phone String?
  adress String?
  email String? 
  status  String?
  image   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
  // RelaciÃ³n con Sales
  sales Sales[] // RelaciÃ³n con el modelo Sales
}

model Provider{
  id      Int      @id @default(autoincrement())
  name    String   
  document String?
  documentNumber String?  @unique
  description String?
  phone String?
  adress String?
  email String? 
  website String?
  status  String?
  image   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entrys    Entry[]   // RelaciÃ³n con el modelo Entry
}

model Entry {
  id          Int       @id @default(autoincrement())
  storeId     Int       // AlmacÃ©n relacionado con la entrada  
  userId      Int       // Usuario que realiza la entrada
  providerId  Int       // Proveedor relacionado con la entrada
  journalId   Int?      // Diario contable relacionado con la entrada
  date        DateTime  @default(now()) // Fecha de la entrada
  description String?   // DescripciÃ³n opcional
  tipoMoneda  String?   // Tipo de moneda (e.g., PEN, USD)
  tipoCambioId Int?      // FK a TipoCambio
  pdfUrl      String?
  guiaUrl     String?   // URL del PDF de la guÃ­a de remisiÃ³n
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  store       Store     @relation(fields: [storeId], references: [id]) // RelaciÃ³n con el modelo Store
  user        User      @relation(fields: [userId], references: [id]) // RelaciÃ³n con el modelo User
  provider    Provider  @relation(fields: [providerId], references: [id]) // RelaciÃ³n con el modelo Provider
  journal     Journal?  @relation(fields: [journalId], references: [id])
  details     EntryDetail[]

  invoice     Invoice?  @relation // RelaciÃ³n 1:1 con Comprobante (sin `fields` ni `references`)
  tipoCambio   TipoCambio? @relation(fields: [tipoCambioId], references: [id])

  shippingGuides ShippingGuide[]

  @@index([storeId])
  @@index([userId])
  @@index([providerId])
  @@index([journalId])
  @@index([date])
}

model Invoice {
  id          Int       @id @default(autoincrement())
  entryId     Int       @unique // Clave forÃ¡nea Ãºnica para la relaciÃ³n 1:1// RelaciÃ³n con la entrada
  serie       String   // Serie del comprobante
  nroCorrelativo String // NÃºmero correlativo del comprobante
  tipoComprobante String?   // NÃºmero del comprobante
  tipoMoneda  String?   // Tipo de moneda (e.g., PEN, USD)
  total       Float?    // Total del comprobante
  fechaEmision DateTime? // Fecha de emisiÃ³n del comprobante
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  entry       Entry     @relation(fields: [entryId], references: [id], onDelete:  Cascade) // RelaciÃ³n con Entry

  @@index([entryId])
}

model Inventory {
  id          Int       @id @default(autoincrement())
  productId   Int       
  storeId     Int  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt 

  InventoryHistory InventoryHistory[] // RelaciÃ³n con el modelo InventoryHistory
  storeOnInventory StoreOnInventory[] // RelaciÃ³n con la tabla intermedia
  product     Product   @relation(fields: [productId], references: [id])

  entryDetails EntryDetail[] // RelaciÃ³n uno-a-muchos con EntryDetail

  @@unique([productId, storeId]) // Clave compuesta
}

model EntryDetail {
  id          Int       @id @default(autoincrement())
  entryId     Int       // RelaciÃ³n con la entrada
  productId   Int       // Producto relacionado
  quantity    Int       // Cantidad de productos ingresados
  price       Float     // Precio unitario del producto
  priceInSoles  Float?      // Precio en soles ya congelado
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  inventoryId Int?      // RelaciÃ³n con Inventory

  entry       Entry     @relation(fields: [entryId], references: [id], onDelete: Cascade) // RelaciÃ³n con el modelo Entry
  product     Product   @relation(fields: [productId], references: [id]) // RelaciÃ³n con el modelo Product
  series      EntryDetailSeries[] // RelaciÃ³n con las series
  inventory   Inventory? @relation(fields: [inventoryId], references: [id]) // RelaciÃ³n con Inventory
  // RelaciÃ³n con SalesDetail
  salesDetails SalesDetail[] // RelaciÃ³n con el modelo SalesDetail

  @@index([entryId])  
  @@index([productId])
}

model EntryDetailSeries {
  id          Int             @id @default(autoincrement())
  entryDetailId Int
  serial      String          @unique
  status      String   @default("active") // Nuevo campo
  entryDetail EntryDetail     @relation(fields: [entryDetailId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Store{
  id      Int      @id @default(autoincrement())
  name    String   @unique
  description String?
  ruc String?
  phone String?
  adress String?
  email String? 
  website String?
  status  String?
  image   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  storeOnInventory StoreOnInventory[] // RelaciÃ³n con la tabla intermedia
  entries   Entry[]   // RelaciÃ³n con el modelo Entry

  // RelaciÃ³n con Transfer como tienda de origen
  transfersFrom Transfer[] @relation("SourceStore")

  // RelaciÃ³n con Transfer como tienda de destino
  transfersTo Transfer[] @relation("DestinationStore")

  // RelaciÃ³n con Sales
  sales Sales[] // RelaciÃ³n con el modelo Sales
  
  // RelaciÃ³n con la tabla de caja
  CashRegister CashRegister[]
}

model StoreOnInventory {
  id          Int       @id @default(autoincrement())
  inventoryId Int
  storeId     Int
  stock       Int       @default(0) // Stock especÃ­fico para esta relaciÃ³n
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  inventory   Inventory @relation(fields: [inventoryId], references: [id])
  store       Store     @relation(fields: [storeId], references: [id])
  // RelaciÃ³n con SalesDetail
  salesDetails SalesDetail[] // RelaciÃ³n con el modelo SalesDetail

  @@index([inventoryId])
  @@index([storeId])
}

model InventoryHistory {
  id          Int       @id @default(autoincrement())
  inventoryId Int       // RelaciÃ³n con el inventario
  userId      Int       // Usuario que realiza el cambio
  action      String    // Tipo de acciÃ³n: "create", "update", "delete"
  description String?   // DescripciÃ³n opcional
  stockChange Int       // Cambio en el stock (positivo o negativo)
  previousStock Int?    // Stock anterior (opcional)
  newStock    Int?      // Stock nuevo (opcional)
  createdAt   DateTime  @default(now()) // Fecha del cambio

  inventory   Inventory @relation(fields: [inventoryId], references: [id])
  user        User      @relation(fields: [userId], references: [id]) // RelaciÃ³n con la tabla de usuarios

  @@index([inventoryId])
  @@index([userId])
  @@index([createdAt])
}

model Transfer {
  id                Int       @id @default(autoincrement())
  sourceStoreId     Int       // ID de la tienda de origen
  destinationStoreId Int      // ID de la tienda de destino
  productId         Int       // ID del producto trasladado
  quantity          Int       // Cantidad trasladada
  description       String?   // DescripciÃ³n opcional
  createdAt         DateTime  @default(now()) // Fecha del traslado

  // RelaciÃ³n con la tabla Store para la tienda de origen
  sourceStore       Store     @relation("SourceStore", fields: [sourceStoreId], references: [id])

  // RelaciÃ³n con la tabla Store para la tienda de destino
  destinationStore  Store     @relation("DestinationStore", fields: [destinationStoreId], references: [id])

  // RelaciÃ³n con la tabla Product
  product           Product   @relation(fields: [productId], references: [id])

  @@index([sourceStoreId]) // Ãndice para optimizar consultas por tienda de origen
  @@index([destinationStoreId]) // Ãndice para optimizar consultas por tienda de destino
  @@index([productId]) // Ãndice para optimizar consultas por producto 
}

model Sales {
  id          Int       @id @default(autoincrement())
  userId      Int       // Usuario que realiza la venta
  storeId     Int       // Tienda donde se realiza la venta
  clientId    Int       // Cliente asociado a la venta
  total       Float     // Total de la venta
  description String?   // DescripciÃ³n opcional
  source      SaleSource @default(POS)
  createdAt   DateTime  @default(now()) // Fecha de la venta
  updatedAt   DateTime  @updatedAt

  user        User      @relation(fields: [userId], references: [id]) // RelaciÃ³n con el usuario
  store       Store     @relation(fields: [storeId], references: [id]) // RelaciÃ³n con la tienda
  client      Client    @relation(fields: [clientId], references: [id]) // RelaciÃ³n con el cliente
  salesDetails SalesDetail[] // RelaciÃ³n con los detalles de la venta
  invoices InvoiceSales[] // RelaciÃ³n con las facturas de venta
  payments      SalePayment[]   // ðŸ‘ˆ RelaciÃ³n con tabla intermedia
  shippingGuides ShippingGuide[]
  order         Orders?

  @@index([userId])
  @@index([storeId])
  @@index([clientId])
  @@index([createdAt])
  @@index([source])
}

model PaymentMethod {
  id          Int      @id @default(autoincrement())
  name        String   @unique // Ejemplo: "Visa", "Yape", "Plin", "Efectivo", "Transferencia"
  description String?  // DescripciÃ³n opcional del mÃ©todo de pago
  isActive    Boolean  @default(true) // Indica si el mÃ©todo de pago estÃ¡ habilitado
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  payments    SalePayment[]  // ðŸ‘ˆ RelaciÃ³n con tabla intermedia
  cashTransactionPayments CashTransactionPaymentMethod[] // RelaciÃ³n con la tabla intermedia de transacciones de caja
}

model SalePayment {
  id               Int            @id @default(autoincrement())
  salesId           Int
  paymentMethodId  Int
  amount           Float          // ðŸ‘ˆ Monto pagado con ese mÃ©todo
  currency         String @default("PEN")        // Tipo de moneda (e.g., PEN, USD)
  transactionId    String?        // âœ… ID de transacciÃ³n para rastrear pagos digitales
  referenceNote    String?        // (opcional) para agregar voucher, observaciÃ³n, etc.
  sale             Sales          @relation(fields: [salesId], references: [id])
  paymentMethod    PaymentMethod  @relation(fields: [paymentMethodId], references: [id])

  @@index([salesId])
  @@index([paymentMethodId])
}

model SalesDetail {
  id          Int       @id @default(autoincrement())
  salesId      Int       // RelaciÃ³n con la venta
  entryDetailId Int          // RelaciÃ³n con el detalle de la entrada
  storeOnInventoryId Int // RelaciÃ³n con el inventario de la tienda
  productId   Int       // Producto relacionado
  series      String[] // Arreglo de series
  quantity    Int       // Cantidad de productos vendidos
  price       Float     // Precio unitario del producto
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  sale        Sales     @relation(fields: [salesId], references: [id], onDelete: Cascade) // RelaciÃ³n con el modelo Sales
  entryDetail EntryDetail @relation(fields: [entryDetailId], references: [id]) // RelaciÃ³n con el modelo EntryDetail
  storeOnInventory StoreOnInventory @relation(fields: [storeOnInventoryId], references: [id]) // RelaciÃ³n con el inventario de la tienda

  @@index([salesId])
  @@index([productId])
  @@index([entryDetailId])
  @@index([storeOnInventoryId])
}

model InvoiceSales {
  id          Int       @id @default(autoincrement())
  salesId     Int       @unique // Clave forÃ¡nea Ãºnica para la relaciÃ³n 1:1// RelaciÃ³n con la entrada
  serie       String   // Serie del comprobante
  nroCorrelativo String // NÃºmero correlativo del comprobante
  tipoComprobante String   // NÃºmero del comprobante
  tipoMoneda  String?   // Tipo de moneda (e.g., PEN, USD)
  total       Float?    // Total del comprobante
  fechaEmision DateTime? // Fecha de emisiÃ³n del comprobante
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  sales       Sales     @relation(fields: [salesId], references: [id], onDelete:  Cascade) // RelaciÃ³n con Entry
  @@unique([tipoComprobante, serie, nroCorrelativo]) // RestricciÃ³n Ãºnica compuesta
}

model Orders {
  id             Int      @id @default(autoincrement())
  code           String   @unique
  salesId        Int?     @unique
  status         OrderStatus @default(PENDING)
  payload        Json?
  shippingName   String
  shippingAddress String
  city           String
  postalCode     String
  phone          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  sale           Sales?   @relation(fields: [salesId], references: [id])

  @@index([salesId])
  OrderTracking OrderTracking[]
}

model OrderTracking {
  id          Int      @id @default(autoincrement())
  orderId     Int
  status      String
  description String
  createdAt   DateTime @default(now())

  order       Orders   @relation(fields: [orderId], references: [id])

  @@index([orderId])
}

model TipoCambio {
  id        Int      @id @default(autoincrement())
  fecha     DateTime           // Fecha del tipo de cambio
  moneda    String             // Ej: "USD", "EUR", "CLP"
  valor     Float              // CuÃ¡nto vale 1 unidad de esa moneda en soles
  createdAt DateTime @default(now())

  entries   Entry[]            // RelaciÃ³n con entradas
  @@unique([fecha, moneda])    // Evita duplicados

  @@index([fecha, moneda]) // ðŸš€ Ã­ndice compuesto
}

model CashRegister {
  id             Int              @id @default(autoincrement())
  name           String           @unique
  description    String?
  storeId        Int
  initialBalance Decimal          @default(0.00)
  currentBalance Decimal          @default(0.00)
  status         CashRegisterStatus @default(ACTIVE)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  store          Store            @relation(fields: [storeId], references: [id])
  transactions   CashTransaction[]
  closures       CashClosure[]

  @@map("cash_registers")
}

model CashTransaction {
  id              Int              @id @default(autoincrement())
  cashRegisterId  Int
  type            CashTransactionType
  amount          Decimal
  description     String?
  userId          Int
  createdAt       DateTime         @default(now())

  cashRegister    CashRegister     @relation(fields: [cashRegisterId], references: [id])
  paymentMethods  CashTransactionPaymentMethod[] // RelaciÃ³n con la tabla intermedia
  user            User             @relation(fields: [userId], references: [id])

  @@map("cash_transactions")
}

model CashTransactionPaymentMethod {
  id                Int             @id @default(autoincrement())
  cashTransactionId Int
  paymentMethodId   Int            // Hacer que el campo sea opcional

  cashTransaction   CashTransaction @relation(fields: [cashTransactionId], references: [id])
  paymentMethod     PaymentMethod  @relation(fields: [paymentMethodId], references: [id]) // RelaciÃ³n opcional
}

model CashClosure {
  id              Int             @id @default(autoincrement())
  cashRegisterId  Int
  userId          Int
  openingBalance  Decimal
  closingBalance  Decimal
  totalIncome     Decimal
  notes           String?
  totalExpense    Decimal
  createdAt       DateTime         @default(now())

  cashRegister    CashRegister     @relation(fields: [cashRegisterId], references: [id])
  user            User             @relation(fields: [userId], references: [id])

  @@map("cash_closures")
}

// Enums
enum CashRegisterStatus {
  ACTIVE
  CLOSED
}

enum CashTransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum SaleSource {
  POS
  WEB
}

enum OrderStatus {
  PENDING
  COMPLETED
  DENIED
}

model ShippingGuide {
  id              Int      @id @default(autoincrement())
  serie           String
  correlativo     String
  motivoTraslado  String
  fechaTraslado   DateTime
  puntoPartida    String
  puntoLlegada    String

  transportistaTipoDocumento  String
  transportistaNumeroDocumento String
  transportistaRazonSocial     String
  transportistaNumeroPlaca     String

  destinatarioTipoDocumento    String
  destinatarioNumeroDocumento  String
  destinatarioRazonSocial      String

  xmlName        String?
  zipName        String?
  cdrAceptado    Boolean
  cdrCode        String?
  cdrDescription String?

  ventaId        Int?       // si estÃ¡ asociada a una venta
  entryId        Int?       // si estÃ¡ asociada a una entrada (traslado)

  createdAt      DateTime  @default(now())

  sale           Sales?    @relation(fields: [ventaId], references: [id])
  entry          Entry?    @relation(fields: [entryId], references: [id])
}

model Review {
  id        Int      @id @default(autoincrement())
  productId Int
  userId    Int
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([productId, userId])
  @@index([productId])
  @@index([userId])
}

model ChatMessage {
  id        Int      @id @default(autoincrement())
  clientId  Int
  senderId  Int
  text      String
  file      String?
  createdAt DateTime @default(now())
  updatedAt DateTime? @updatedAt
  deletedAt DateTime?
  seenAt    DateTime?

  client User @relation("ClientMessages", fields: [clientId], references: [id])
  sender User @relation("SenderMessages", fields: [senderId], references: [id])

  @@index([clientId])
  @@index([senderId])
}

model Favorite {
  id        Int      @id @default(autoincrement())
  userId    Int
  productId Int
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

model NewsletterSubscriber {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  createdAt DateTime @default(now())
}

enum AuditAction {
  CREATED
  UPDATED
  DELETED
  LOGIN
  LOGOUT
  OTHER
}

model AuditLog {
  id         String      @id @default(uuid())
  actorId    Int?
  actorEmail String?
  entityType String?
  entityId   String?
  action     AuditAction
  summary    String?
  diff       Json?
  ip         String?
  userAgent  String?
  journalEntryId Int?
  journalEntry   JournalEntry? @relation(fields: [journalEntryId], references: [id])
  createdAt  DateTime    @default(now())

  @@index([createdAt])
  @@index([actorId])
  @@index([entityType])
  @@index([action])
  @@index([journalEntryId])
}

enum TemplateVersion {
  V1
  V2
}

enum PublishAdapter {
  LOCAL_STUB
}

model Org {
  id        Int       @id @default(autoincrement())
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  campaigns      Campaign[]
  publishTargets PublishTarget[]

  @@unique([name, deletedAt])
}

model Campaign {
  id        Int       @id @default(autoincrement())
  orgId     Int
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  org       Org        @relation(fields: [orgId], references: [id])
  templates Template[]
  creatives Creative[]
  runs      Run[]

  @@unique([orgId, name, deletedAt])
  @@index([orgId])
}

model Template {
  id         Int             @id @default(autoincrement())
  campaignId Int
  name       String
  version    TemplateVersion
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  deletedAt  DateTime?

  campaign  Campaign   @relation(fields: [campaignId], references: [id])
  creatives Creative[]

  @@unique([campaignId, version, deletedAt])
  @@index([campaignId])
}

model Creative {
  id         Int       @id @default(autoincrement())
  campaignId Int
  templateId Int
  name       String
  data       Json
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  campaign Campaign @relation(fields: [campaignId], references: [id])
  template Template @relation(fields: [templateId], references: [id])
  assets   Asset[]

  @@unique([campaignId, name, deletedAt])
  @@index([campaignId])
  @@index([templateId])
}

model Run {
  id         Int       @id @default(autoincrement())
  campaignId Int
  name       String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  campaign Campaign           @relation(fields: [campaignId], references: [id])
  assets   Asset[]
  logs     PublishTargetLog[]

  @@unique([campaignId, name, deletedAt])
  @@index([campaignId])
}

model Asset {
  id         Int       @id @default(autoincrement())
  runId      Int
  creativeId Int
  uri        String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  run      Run                @relation(fields: [runId], references: [id])
  creative Creative           @relation(fields: [creativeId], references: [id])
  logs     PublishTargetLog[]

  @@unique([runId, uri, deletedAt])
  @@index([runId])
  @@index([creativeId])
}

model PublishTarget {
  id        Int            @id @default(autoincrement())
  orgId     Int
  name      String
  adapter   PublishAdapter
  config    Json
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  deletedAt DateTime?

  org  Org                @relation(fields: [orgId], references: [id])
  logs PublishTargetLog[]

  @@unique([orgId, name, deletedAt])
  @@index([orgId])
}

model PublishTargetLog {
  id              Int       @id @default(autoincrement())
  publishTargetId Int
  assetId         Int
  status          String
  message         String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  publishTarget PublishTarget @relation(fields: [publishTargetId], references: [id])
  asset         Asset         @relation(fields: [assetId], references: [id])
  run           Run?          @relation(fields: [runId], references: [id])
  runId         Int?

  @@unique([publishTargetId, assetId, deletedAt])
  @@index([publishTargetId])
  @@index([assetId])
  @@index([runId])
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum Nature {
  DEBIT
  CREDIT
}

enum JournalType {
  GENERAL
  SALES
  PURCHASE
  CASH
  BANK
}

enum EntryStatus {
  DRAFT
  POSTED
  VOID
}

enum PleType {
  SALES
  PURCHASE
  JOURNAL
}

enum PeriodStatus {
  OPEN
  CLOSED
}

model Account {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  name      String
  parentId  Int?
  parent    Account? @relation("AccountChildren", fields: [parentId], references: [id])
  children  Account[] @relation("AccountChildren")
  level     Int
  isPosting Boolean   @default(false)
  taxCodes  TaxCode[]
}

model Journal {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entries   Entry[]
}

model Period {
  id         Int          @id @default(autoincrement())
  startDate  DateTime
  endDate    DateTime
  status     PeriodStatus @default(OPEN)
  entries    JournalEntry[]
  pleExports PleExport[]

  @@unique([startDate, endDate])
}

model JournalEntry {
  id          Int         @id @default(autoincrement())
  journalId   Int
  periodId    Int
  date        DateTime
  status      EntryStatus @default(DRAFT)
  description String?
  debitTotal  Decimal     @default(0.00)
  creditTotal Decimal     @default(0.00)

  period    Period    @relation(fields: [periodId], references: [id])
  lines     JournalLine[]
  documents DocumentLink[]
  auditLogs AuditLog[]

  @@index([journalId])
  @@index([periodId])
  // @@check(name: "balance_check", expression: "debitTotal = creditTotal")
}

model JournalLine {
  id        Int      @id @default(autoincrement())
  entryId   Int
  accountId Int
  taxCodeId Int?
  description String?
  debit     Decimal @default(0.00)
  credit    Decimal @default(0.00)

  entry   JournalEntry @relation(fields: [entryId], references: [id])
  taxCode TaxCode?     @relation(fields: [taxCodeId], references: [id])

  @@index([entryId])
  @@index([accountId])
  // @@check(name: "debit_credit_check", expression: "(debit = 0 AND credit > 0) OR (credit = 0 AND debit > 0)")
}

model TaxCode {
  id    Int      @id @default(autoincrement())
  code  String   @unique
  rate  Decimal
  lines JournalLine[]
  name              String
  sunatTributoCode  String
  sunatOperacionType String
  contraAccountId   Int?
  contraAccount     Account? @relation(fields: [contraAccountId], references: [id])

  @@index([code])
}

model DocumentLink {
  id          Int      @id @default(autoincrement())
  entryId     Int
  url         String
  description String?

  entry JournalEntry @relation(fields: [entryId], references: [id])

  @@index([entryId])
}

model PleExport {
  id         Int       @id @default(autoincrement())
  periodId   Int
  type       PleType
  fileUrl    String
  exportedAt DateTime  @default(now())

  period Period @relation(fields: [periodId], references: [id])

  @@index([periodId])
  @@index([type])
}

model TrialBalanceCache {
  id        Int      @id @default(autoincrement())
  startDate DateTime
  endDate   DateTime
  data      Json
  createdAt DateTime @default(now())
}