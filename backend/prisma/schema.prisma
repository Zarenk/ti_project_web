// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BusinessVertical {
  GENERAL
  RESTAURANTS
  RETAIL
  SERVICES
  MANUFACTURING
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  barcode     String?  @unique // Opcional pero Unico
  qrCode      String?  @unique // Opcional pero Unico
  description String?
  brandName   String?  @map("brand")
  price       Float
  priceSell   Float?
  status      String?
  image       String?
  images      String[]
  organizationId Int?
  companyId      Int?
  extraAttributes Json?
  isVerticalMigrated Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  // Relacion con Brand
  brandId Int?
  brand   Brand? @relation(fields: [brandId], references: [id])

  // NUEVO: Relacion directa con Organization
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  // NUEVA Relacion CON COMPANY
  company     Company?      @relation(fields: [companyId], references: [id], onDelete: SetNull)

  // Relacion con Category
  categoryId  Int
  category    Category      @relation(fields: [categoryId], references: [id])
  entryDetail EntryDetail[]
  inventory   Inventory[]
  isDemo      Boolean  @default(false)

  specification ProductSpecification?
  features      ProductFeature[]
  reviews       Review[]
  favorites     Favorite[]

  // Relacion con Transfer
  transfers Transfer[] // Relacion con el modelo Transfer

  @@unique([organizationId, name])
  @@index([categoryId])
  @@index([name])
  @@index([brandId])
  @@index([organizationId, name])
  @@index([organizationId, companyId]) // Indice para filtros eficientes
  @@index([companyId])
}

model ProductSpecification {
  id           Int      @id @default(autoincrement())
  productId    Int      @unique
  processor    String?
  ram          String?
  storage      String?
  graphics     String?
  screen       String?
  resolution   String?
  refreshRate  String?
  connectivity String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id])

  @@index([productId])
}

model ProductFeature {
  id          Int      @id @default(autoincrement())
  productId   Int
  icon        String?
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id])

  @@index([productId])
}

model Brand {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  logoSvg   String?
  logoPng   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]
  keywords Keyword[]
}

model Keyword {
  id      Int    @id @default(autoincrement())
  name    String
  brandId Int
  brand   Brand  @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([name])
  @@index([brandId])
}

model SiteSettings {
  id             Int      @id @default(autoincrement())
  tenantKey      String   @unique @default("org:0|company:0")
  organizationId Int?
  companyId      Int?
  data           Json
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  company        Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([companyId])
}

model CatalogCover {
  id           Int      @id @default(autoincrement())
  imagePath    String
  originalName String?
  mimeType     String?
  isActive     Boolean  @default(true)
  organizationId  Int?
  companyId       Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  company         Company?      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([organizationId, companyId, isActive])
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  status      String?
  image       String?
  organizationId Int?
  companyId      Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isDemo      Boolean  @default(false)

  // Relacion con Product
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  company        Company?      @relation(fields: [companyId], references: [id], onDelete: SetNull) // NUEVO
  products Product[]

  @@unique([organizationId, name])
  @@index([organizationId, name])
  @@index([companyId])                          // para auditoria
  @@index([organizationId, companyId])          // (opcional) para informes
}

enum UserRole {
  SUPER_ADMIN_GLOBAL
  SUPER_ADMIN_ORG
  ADMIN
  EMPLOYEE
  CLIENT
  GUEST
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  username     String   @unique
  password     String
  role         UserRole @default(CLIENT) // Enum para roles de usuario
  status       String   @default("ACTIVO")
  organizationId      Int?
  lastOrgId    Int?
  lastCompanyId Int?
  lastContextUpdatedAt DateTime?
  lastContextHash String?
  failedLoginAttempts Int      @default(0)
  lockUntil    DateTime?
  isPermanentlyLocked Boolean  @default(false)
  client       Client? // Relacion opcional con el modelo Client
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tokenVersion Int      @default(0)
  isDemo       Boolean  @default(false)
  isPublicSignup Boolean @default(false)
  emailVerificationToken String? @unique
  emailVerifiedAt DateTime?

  lastOrg      Organization? @relation("UserLastOrganization", fields: [lastOrgId], references: [id], onDelete: SetNull)
  lastCompany  Company?      @relation("UserLastCompany", fields: [lastCompanyId], references: [id], onDelete: SetNull)
  entrys           Entry[] // Relacion con el modelo Entry
  inventoryHistory InventoryHistory[] // Relacion con el modelo InventoryHistory
  // Relacion con Sales
  sales            Sales[]
  cashTransactions CashTransaction[] // Relacion con la tabla de transacciones de caja
  cashClosures     CashClosure[] // Relacion con la tabla de cierres de caja
  reviews          Review[]
  clientMessages   ChatMessage[]      @relation("ClientMessages")
  sentMessages     ChatMessage[]      @relation("SenderMessages")
  favorites        Favorite[]
  sunatStoredPdfs  SunatStoredPdf[]

  memberships OrganizationMembership[]
  createdInvoiceTemplates InvoiceTemplate[] @relation("InvoiceTemplateCreatedBy")
  updatedInvoiceTemplates InvoiceTemplate[] @relation("InvoiceTemplateUpdatedBy")
  verticalChangeAudits VerticalChangeAudit[]
  companyVerticalChangeAudits CompanyVerticalChangeAudit[]
  contextPreferences UserContextPreference[]
  contextHistory UserContextHistory[]
  requestedExports OrganizationDataExport[] @relation("OrganizationDataExportsRequestedBy")
  @@index([email])
  @@index([username])
  @@index([organizationId, email])
  @@index([lastOrgId])
  @@index([lastCompanyId])
}

model UserContextPreference {
  id              Int      @id @default(autoincrement())
  userId          Int
  orgId           Int
  companyId       Int?
  totalSelections Int      @default(1)
  lastSelectedAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId, companyId], name: "user_context_preference_unique")
  @@index([userId, lastSelectedAt])
}

model UserContextHistory {
  id         Int      @id @default(autoincrement())
  userId     Int
  orgId      Int
  companyId  Int?
  device     String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

enum OrganizationMembershipRole {
  OWNER
  SUPER_ADMIN
  ADMIN
  MEMBER
  VIEWER
}

model Organization {
  id        Int       @id @default(autoincrement())
  name      String
  slug      String?   @unique
  code      String?   @unique
  status    String    @default("ACTIVE")
  businessVertical BusinessVertical @default(GENERAL)
  productSchemaEnforced Boolean     @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  orders       Orders[]
  units        OrganizationUnit[]
  companies    Company[]
  memberships  OrganizationMembership[]
  settings     OrganizationSetting?
  providers    Provider[]
  products     Product[]
  categories   Category[]
  accEntries   AccEntry[]
  exchangeRates TipoCambio[]
  entrySeries  EntryDetailSeries[]
  catalogCover CatalogCover[]
  siteSettings SiteSettings[]
  sunatTransmissions SunatTransmission[]
  sunatStoredPdfs   SunatStoredPdf[]
  invoiceTemplates InvoiceTemplate[]
  invoiceSamples InvoiceSample[]
  monitoringAlerts MonitoringAlert[]
  monitoringAlertEvents MonitoringAlertEvent[]
  userLastContext  User[] @relation("UserLastOrganization")
  subscription     Subscription?
  billingPaymentMethods BillingPaymentMethod[]
  subscriptionInvoices SubscriptionInvoice[]
  onboardingProgress OnboardingProgress?
  dataExports   OrganizationDataExport[] @relation("OrganizationDataExports")
  auditLogs   AuditLog[]
  verticalChangeAudits VerticalChangeAudit[]
  rollbackSnapshots    VerticalRollbackSnapshot[]
  verticalOverride     OrganizationVerticalOverride?
  companyVerticalChangeAudits CompanyVerticalChangeAudit[]
  companyVerticalRollbackSnapshots CompanyVerticalRollbackSnapshot[]

  @@unique([name])
  @@index([status])
  @@index([businessVertical])
}

model OrganizationVerticalOverride {
  id             Int           @id @default(autoincrement())
  organizationId Int           @unique
  configJson     Json
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model Company {
  id                    Int            @id @default(autoincrement())
  organizationId        Int
  name                  String
  legalName             String?
  taxId                 String?        @unique
  status                String         @default("ACTIVE")
  businessVertical      BusinessVertical @default(GENERAL)
  productSchemaEnforced Boolean        @default(false)
  sunatEnvironment      String         @default("BETA")
  sunatRuc              String?
  sunatBusinessName     String?
  sunatAddress          String?
  sunatPhone            String?
  sunatContactEmail     String?
  logoUrl               String?
  primaryColor          String?
  secondaryColor        String?
  sunatSolUserBeta      String?
  sunatSolPasswordBeta  String?
  sunatCertPathBeta     String?
  sunatKeyPathBeta      String?
  sunatSolUserProd      String?
  sunatSolPasswordProd  String?
  sunatCertPathProd     String?
  sunatKeyPathProd      String?
  sunatCertificateNotes String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  units          OrganizationUnit[]
  stores         Store[]
  sales          Sales[]
  invoiceSales  InvoiceSales[]
  orders         Orders[]
  clients        Client[]
  inventoryHistories InventoryHistory[]
  products           Product[] // NUEVA RELACION
  categories         Category[]
  accEntries         AccEntry[]
  catalogCover CatalogCover[]
  siteSettings SiteSettings[]
  sunatTransmissions SunatTransmission[]
  userLastContext  User[] @relation("UserLastCompany")
  sunatStoredPdfs   SunatStoredPdf[]
  documentSequences CompanyDocumentSequence[]
  invoiceTemplates InvoiceTemplate[]
  invoiceSamples InvoiceSample[]
  monitoringAlerts MonitoringAlert[]
  monitoringAlertEvents MonitoringAlertEvent[]
  subscriptionInvoices SubscriptionInvoice[]
  auditLogs     AuditLog[]
  verticalOverride CompanyVerticalOverride?
  companyVerticalChangeAudits CompanyVerticalChangeAudit[]
  companyVerticalRollbackSnapshots CompanyVerticalRollbackSnapshot[]

  @@unique([organizationId, name])
  @@index([organizationId, status])
}

enum SubscriptionInterval {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
}

enum BillingPaymentProvider {
  STRIPE
  MERCADOPAGO
  CULQI
  MANUAL
}

enum BillingPaymentMethodStatus {
  ACTIVE
  INACTIVE
}

enum OrganizationDataExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum OrganizationCleanupStatus {
  PENDING
  SCHEDULED
  PROCESSING
  COMPLETED
  FAILED
}


enum SubscriptionInvoiceStatus {
  PENDING
  PAID
  FAILED
  VOID
}

enum SignupAttemptStatus {
  PENDING
  SUCCESS
  FAILED
  BLOCKED
}

model SubscriptionPlan {
  id          Int                 @id @default(autoincrement())
  code        String              @unique
  name        String
  description String?
  interval    SubscriptionInterval @default(MONTHLY)
  price       Decimal             @default(0.00)
  currency    String              @default("PEN")
  trialDays   Int?                @default(14)
  features    Json?
  quotas      Json?
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  subscriptions Subscription[]

  @@index([isActive])
}

model BillingPaymentMethod {
  id              Int                          @id @default(autoincrement())
  organizationId  Int
  provider        BillingPaymentProvider       @default(STRIPE)
  externalId      String
  brand           String?
  last4           String?
  expMonth        Int?
  expYear         Int?
  country         String?
  status          BillingPaymentMethodStatus   @default(ACTIVE)
  isDefault       Boolean                      @default(false)
  metadata        Json?
  createdAt       DateTime                     @default(now())
  updatedAt       DateTime                     @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscriptions Subscription[] @relation("SubscriptionDefaultPaymentMethod")
  invoices      SubscriptionInvoice[]

  @@unique([organizationId, externalId])
  @@index([organizationId, status])
}

model Subscription {
  id                    Int                @id @default(autoincrement())
  planId                Int
  organizationId        Int                @unique
  status                SubscriptionStatus @default(TRIAL)
  billingCustomerId     String?
  trialEndsAt           DateTime?
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  cancelAtPeriodEnd     Boolean            @default(false)
  canceledAt            DateTime?
  metadata              Json?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  defaultPaymentMethodId Int?

  plan          SubscriptionPlan       @relation(fields: [planId], references: [id], onDelete: Restrict)
  organization  Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices      SubscriptionInvoice[]
  defaultPaymentMethod BillingPaymentMethod? @relation("SubscriptionDefaultPaymentMethod", fields: [defaultPaymentMethodId], references: [id], onDelete: SetNull)

  @@index([status])
}

model SubscriptionInvoice {
  id                 Int                        @id @default(autoincrement())
  subscriptionId     Int
  organizationId     Int
  companyId          Int
  paymentMethodId    Int?
  providerInvoiceId  String?
  status             SubscriptionInvoiceStatus  @default(PENDING)
  amount             Decimal                    @default(0.00)
  subtotal           Decimal                    @default(0.00)
  taxRate            Decimal                    @default(0.00)
  taxAmount          Decimal                    @default(0.00)
  currency           String                     @default("PEN")
  billingPeriodStart DateTime?
  billingPeriodEnd   DateTime?
  dueDate            DateTime?
  paidAt             DateTime?
  metadata           Json?
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt

  subscription  Subscription         @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  organization  Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  company       Company              @relation(fields: [companyId], references: [id], onDelete: Restrict)
  paymentMethod BillingPaymentMethod? @relation(fields: [paymentMethodId], references: [id], onDelete: SetNull)
  sunatTransmissions SunatTransmission[]

  @@index([subscriptionId])
  @@index([organizationId])
  @@index([companyId])
  @@index([status])
}

enum DemoDataStatus {
  NONE
  SEEDED
  CLEANING
}

model OnboardingProgress {
  id               Int             @id @default(autoincrement())
  organizationId   Int             @unique
  currentStep      Int             @default(1)
  companyProfile   Json?
  storeSetup       Json?
  sunatSetup       Json?
  dataImport       Json?
  demoStatus       DemoDataStatus  @default(NONE)
  demoSeededAt     DateTime?
  demoClearedAt    DateTime?
  wizardDismissedAt DateTime?
  isCompleted      Boolean         @default(false)
  completedAt      DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  organization     Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([updatedAt])
}

model PublicSignupAttempt {
  id          Int                  @id @default(autoincrement())
  email       String
  domain      String
  ip          String?
  deviceHash  String?
  userAgent   String?
  status      SignupAttemptStatus  @default(PENDING)
  errorMessage String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@index([email, createdAt])
  @@index([domain, createdAt])
  @@index([ip, createdAt])
  @@index([deviceHash, createdAt])
}

model SignupBlocklist {
  id           Int       @id @default(autoincrement())
  ip           String?
  deviceHash   String?
  domain       String?
  reason       String?
  blockedUntil DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([ip])
  @@index([deviceHash])
  @@index([domain])
  @@index([blockedUntil])
}

model TaxRate {
  id          Int      @id @default(autoincrement())
  countryCode String
  regionCode  String?
  rate        Decimal  @default(0.00)
  description String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([countryCode, regionCode])
  @@index([isDefault])
  @@unique([countryCode, regionCode])
}

model SunatTransmission {
  id             Int      @id @default(autoincrement())
  companyId      Int
  organizationId Int?
  saleId         Int?
  subscriptionInvoiceId Int?
  environment    String   @default("BETA")
  documentType   String
  serie          String?
  correlativo    String?
  zipFilePath    String?
  ticket         String?
  status         String   @default("PENDING")
  response       Json?
  payload        Json?
  errorMessage   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  company      Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  sale         Sales?        @relation(fields: [saleId], references: [id], onDelete: SetNull)
  subscriptionInvoice SubscriptionInvoice? @relation(fields: [subscriptionInvoiceId], references: [id], onDelete: SetNull)

  @@index([companyId, status])
  @@index([organizationId])
  @@index([saleId])
  @@index([subscriptionInvoiceId])
}

model SunatStoredPdf {
  id             Int      @id @default(autoincrement())
  organizationId Int
  companyId      Int
  type           String
  filename       String
  relativePath   String
  createdBy      Int?
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  company      Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  uploadedBy   User?        @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@unique([companyId, filename])
  @@index([organizationId])
  @@index([companyId, type])
}

model OrganizationDataExport {
  id             Int                           @id @default(autoincrement())
  organizationId Int
  requestedBy    Int?
  status         OrganizationDataExportStatus  @default(PENDING)
  filePath       String?
  errorMessage   String?
  requestedAt    DateTime                      @default(now())
  completedAt    DateTime?
  cleanupStatus  OrganizationCleanupStatus     @default(PENDING)
  cleanupCompletedAt DateTime?
  expiresAt      DateTime?

  organization    Organization @relation("OrganizationDataExports", fields: [organizationId], references: [id], onDelete: Cascade)
  requestedByUser User?        @relation("OrganizationDataExportsRequestedBy", fields: [requestedBy], references: [id], onDelete: SetNull)

  @@index([organizationId, status])
}

model VerticalChangeAudit {
  id             Int              @id @default(autoincrement())
  organizationId Int
  userId         Int?
  oldVertical    BusinessVertical
  newVertical    BusinessVertical
  changeReason   String?
  warningsJson   Json?
  success        Boolean         @default(true)
  createdAt      DateTime        @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([createdAt])
}

model VerticalRollbackSnapshot {
  id             String   @id
  organizationId Int
  snapshotData   Json
  createdAt      DateTime @default(now())
  expiresAt      DateTime

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([expiresAt])
}

model CompanyVerticalOverride {
  companyId Int    @id
  configJson Json?

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

model CompanyVerticalChangeAudit {
  id             Int              @id @default(autoincrement())
  companyId      Int
  organizationId Int
  userId         Int?
  oldVertical    BusinessVertical
  newVertical    BusinessVertical
  changeReason   String?
  warningsJson   Json?
  success        Boolean         @default(true)
  createdAt      DateTime        @default(now())

  company      Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user        User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([organizationId])
  @@index([createdAt])
}

model CompanyVerticalRollbackSnapshot {
  id             String   @id
  companyId      Int
  organizationId Int
  snapshotData   Json
  createdAt      DateTime @default(now())
  expiresAt      DateTime

  company      Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([organizationId])
  @@index([expiresAt])
}


model OrganizationUnit {
  id              Int                @id @default(autoincrement())
  organizationId  Int
  companyId       Int?
  parentUnitId    Int?
  name            String
  code            String?
  status          String             @default("ACTIVE")
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  organization    Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  company         Company?           @relation(fields: [companyId], references: [id], onDelete: SetNull)
  parent          OrganizationUnit?  @relation("OrganizationUnitHierarchy", fields: [parentUnitId], references: [id])
  children        OrganizationUnit[] @relation("OrganizationUnitHierarchy")
  memberships     OrganizationMembership[]

  @@unique([organizationId, name])
  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([companyId])
  @@index([parentUnitId])
}

model OrganizationMembership {
  id                  Int                          @id @default(autoincrement())
  userId              Int
  organizationId      Int
  organizationUnitId  Int?
  role                OrganizationMembershipRole   @default(MEMBER)
  isDefault           Boolean                      @default(false)
  createdAt           DateTime                     @default(now())
  updatedAt           DateTime                     @updatedAt

  user                User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization        Organization                 @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationUnit    OrganizationUnit?            @relation(fields: [organizationUnitId], references: [id], onDelete: SetNull)

  @@unique([userId, organizationId, organizationUnitId])
  @@index([organizationId])
  @@index([organizationUnitId])
  @@index([userId, isDefault])
}

model OrganizationSetting {
  id              Int           @id @default(autoincrement())
  organizationId  Int           @unique
  preferences     Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model Client {
  id             Int      @id @default(autoincrement())
  userId         Int      @unique
  name           String
  type           String?
  typeNumber     String?  @unique
  phone          String?
  adress         String?
  email          String?
  status         String?
  image          String?
  organizationId Int?
  companyId      Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  isDemo         Boolean  @default(false)

  user  User    @relation(fields: [userId], references: [id])
  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  // Relacion con Sales
  sales Sales[] // Relacion con el modelo Sales

  @@index([organizationId, name])
  @@index([companyId])
}

model Provider {
  id             Int      @id @default(autoincrement())
  name           String
  document       String?
  documentNumber String?  @unique
  description    String?
  phone          String?
  adress         String?
  email          String?
  website        String?
  status         String?
  image          String?
  organizationId Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  entrys     Entry[] // Relacion con el modelo Entry
  accEntries AccEntry[] // Relacion con el modelo AccEntry
  invoiceTemplates InvoiceTemplate[]

  @@index([organizationId])
  @@unique([organizationId, documentNumber]) // NUEVO: unicidad por organizacion
}

model InvoiceTemplate {
  id             Int      @id @default(autoincrement())
  organizationId Int?
  companyId      Int?
  providerId     Int?
  providerName   String?
  documentType   String
  version        Int      @default(1)
  priority       Int      @default(100)
  isActive       Boolean  @default(true)
  checksum       String?
  regexRules     Json?
  fieldMappings  Json?
  extractionHints Json?
  sampleFilename String?
  notes          String?
  createdById    Int?
  updatedById    Int?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  company      Company?      @relation(fields: [companyId], references: [id], onDelete: SetNull)
  provider     Provider?     @relation(fields: [providerId], references: [id], onDelete: SetNull)
  createdBy    User?         @relation("InvoiceTemplateCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy    User?         @relation("InvoiceTemplateUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)
  samples      InvoiceSample[] @relation("InvoiceTemplateSamples")

  @@index([organizationId, companyId])
  @@index([providerId])
  @@index([documentType])
  @@unique([organizationId, companyId, providerId, documentType, version])
}

model MonitoringAlert {
  id             Int       @id @default(autoincrement())
  organizationId Int?
  companyId      Int?
  alertType      String
  providerName   String?
  entityType     String?
  entityId       Int?
  status         String    @default("ACTIVE")
  failureCount   Int       @default(0)
  lastFailureAt  DateTime?
  resolvedAt     DateTime?
  metadata       Json?
  identifier     String    @unique
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  company      Company?      @relation(fields: [companyId], references: [id], onDelete: SetNull)
  events       MonitoringAlertEvent[]

  @@index([alertType, status])
  @@index([organizationId, companyId, status])
}

model MonitoringAlertEvent {
  id             Int       @id @default(autoincrement())
  alertId        Int?
  organizationId Int?
  companyId      Int?
  alertType      String
  status         String
  severity       String    @default("INFO")
  message        String
  metadata       Json?
  createdAt      DateTime  @default(now())

  alert        MonitoringAlert? @relation(fields: [alertId], references: [id], onDelete: Cascade)
  organization Organization?    @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  company      Company?         @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@index([organizationId, companyId, alertType])
  @@index([alertId])
}

enum PaymentTerm {
  CASH
  CREDIT
}

enum EntryPaymentMethod {
  CASH
  CREDIT
}

model Entry {
  id           Int      @id @default(autoincrement())
  storeId      Int // Almacen relacionado con la entrada  
  userId       Int // Usuario que realiza la entrada
  providerId   Int // Proveedor relacionado con la entrada
  journalId    Int? // Diario contable relacionado con la entrada
  date         DateTime @default(now()) // Fecha de la entrada
  description  String? // Descripcion opcional
  tipoMoneda   String? // Tipo de moneda (e.g., PEN, USD)
  tipoCambioId Int? // FK a TipoCambio
  paymentMethod EntryPaymentMethod @default(CASH)
  paymentTerm  PaymentTerm        @default(CASH)
  serie        String?
  correlativo  String?
  providerName String?
  totalGross   Decimal?
  igvRate      Decimal            @default(0.18)
  pdfUrl       String?
  guiaUrl      String? // URL del PDF de la guia de remision
  organizationId Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  referenceId String? @unique

  store    Store         @relation(fields: [storeId], references: [id]) // Relacion con el modelo Store
  user     User          @relation(fields: [userId], references: [id]) // Relacion con el modelo User
  provider Provider      @relation(fields: [providerId], references: [id]) // Relacion con el modelo Provider
  journal  Journal?      @relation(fields: [journalId], references: [id])
  details  EntryDetail[]

  invoice    Invoice?    @relation // Relacion 1:1 con Comprobante (sin `fields` ni `references`)
  tipoCambio TipoCambio? @relation(fields: [tipoCambioId], references: [id])

  shippingGuides ShippingGuide[]
  invoiceSamples InvoiceSample[]

  @@index([storeId])
  @@index([userId])
  @@index([providerId])
  @@index([journalId])
  @@index([date])
  @@index([organizationId, date])
}

model Invoice {
  id              Int       @id @default(autoincrement())
  entryId         Int       @unique // Clave foranea Unica para la Relacion 1:1// Relacion con la entrada
  serie           String // Serie del comprobante
  nroCorrelativo  String // Numero correlativo del comprobante
  tipoComprobante String? // Numero del comprobante
  tipoMoneda      String? // Tipo de moneda (e.g., PEN, USD)
  total           Float? // Total del comprobante
  fechaEmision    DateTime? // Fecha de emision del comprobante
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  entry Entry @relation(fields: [entryId], references: [id], onDelete: Cascade) // Relacion con Entry

  @@index([entryId])
}

model Inventory {
  id        Int      @id @default(autoincrement())
  productId Int
  storeId   Int
  organizationId Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  InventoryHistory InventoryHistory[] // Relacion con el modelo InventoryHistory
  storeOnInventory StoreOnInventory[] // Relacion con la tabla intermedia
  product          Product            @relation(fields: [productId], references: [id])

  entryDetails EntryDetail[] // Relacion uno-a-muchos con EntryDetail

  @@unique([productId, storeId]) // Clave compuesta
  @@index([organizationId, productId])
}

model EntryDetail {
  id           Int      @id @default(autoincrement())
  entryId      Int // Relacion con la entrada
  productId    Int // Producto relacionado
  quantity     Int // Cantidad de productos ingresados
  price        Float // Precio unitario del producto
  priceInSoles Float? // Precio en soles ya congelado
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  inventoryId Int? // Relacion con Inventory

  entry        Entry               @relation(fields: [entryId], references: [id], onDelete: Cascade) // Relacion con el modelo Entry
  product      Product             @relation(fields: [productId], references: [id]) // Relacion con el modelo Product
  series       EntryDetailSeries[] // Relacion con las series
  inventory    Inventory?          @relation(fields: [inventoryId], references: [id]) // Relacion con Inventory
  // Relacion con SalesDetail
  salesDetails SalesDetail[] // Relacion con el modelo SalesDetail

  @@index([entryId])
  @@index([productId])
}

model EntryDetailSeries {
  id            Int         @id @default(autoincrement())
  entryDetailId Int
  serial        String
  status        String      @default("active") // Nuevo campo
  organizationId Int?
  entryDetail   EntryDetail @relation(fields: [entryDetailId], references: [id], onDelete: Cascade)
  organization  Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([organizationId, serial])
  @@index([organizationId, serial])
}

model Store {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  ruc         String?
  phone       String?
  adress      String?
  email       String?
  website     String?
  status      String?
  image       String?
  organizationId Int?
  companyId      Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  storeOnInventory StoreOnInventory[] // Relacion con la tabla intermedia
  entries          Entry[] // Relacion con el modelo Entry

  // Relacion con Transfer como tienda de origen
  transfersFrom Transfer[] @relation("SourceStore")

  // Relacion con Transfer como tienda de destino
  transfersTo Transfer[] @relation("DestinationStore")

  // Relacion con Sales
  sales Sales[] // Relacion con el modelo Sales
  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Relacion con la tabla de caja
  CashRegister CashRegister[]
  @@index([organizationId, name])
}

model StoreOnInventory {
  id          Int      @id @default(autoincrement())
  inventoryId Int
  storeId     Int
  stock       Int      @default(0) // Stock especifico para esta relaciÃ³n
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  inventory    Inventory     @relation(fields: [inventoryId], references: [id])
  store        Store         @relation(fields: [storeId], references: [id])
  // Relacion con SalesDetail
  salesDetails SalesDetail[] // Relacion con el modelo SalesDetail

  @@index([inventoryId])
  @@index([storeId])
}

model InventoryHistory {
  id            Int      @id @default(autoincrement())
  inventoryId   Int // Relacion con el inventario
  userId        Int // Usuario que realiza el cambio
  action        String // Tipo de accion: "create", "update", "delete"
  description   String? // Descripcion opcional
  stockChange   Int // Cambio en el stock (positivo o negativo)
  previousStock Int? // Stock anterior (opcional)
  newStock      Int? // Stock nuevo (opcional)
  organizationId Int?
  companyId      Int?
  createdAt     DateTime @default(now()) // Fecha del cambio

  inventory Inventory @relation(fields: [inventoryId], references: [id])
  user      User      @relation(fields: [userId], references: [id]) // Relacion con la tabla de usuarios
  company   Company?  @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@index([inventoryId])
  @@index([userId])
  @@index([createdAt])
  @@index([organizationId, createdAt])
  @@index([companyId, createdAt])
}

model Transfer {
  id                 Int      @id @default(autoincrement())
  sourceStoreId      Int // ID de la tienda de origen
  destinationStoreId Int // ID de la tienda de destino
  productId          Int // ID del producto trasladado
  quantity           Int // Cantidad trasladada
  description        String? // Descripcion opcional
  organizationId     Int?
  createdAt          DateTime @default(now()) // Fecha del traslado

  // Relacion con la tabla Store para la tienda de origen
  sourceStore Store @relation("SourceStore", fields: [sourceStoreId], references: [id])

  // Relacion con la tabla Store para la tienda de destino
  destinationStore Store @relation("DestinationStore", fields: [destinationStoreId], references: [id])

  // Relacion con la tabla Product
  product Product @relation(fields: [productId], references: [id])

  @@index([sourceStoreId]) // Indice para optimizar consultas por tienda de origen
  @@index([destinationStoreId]) // Indice para optimizar consultas por tienda de destino
  @@index([productId]) // Indice para optimizar consultas por producto
  @@index([organizationId, createdAt])
}

model Sales {
  id          Int        @id @default(autoincrement())
  userId      Int // Usuario que realiza la venta
  storeId     Int // Tienda donde se realiza la venta
  clientId    Int // Cliente asociado a la venta
  total       Float // Total de la venta
  description String? // Descripcion opcional
  source      SaleSource @default(POS)
  organizationId Int?
  companyId      Int?
  createdAt   DateTime   @default(now()) // Fecha de la venta
  updatedAt   DateTime   @updatedAt
  referenceId String? @unique

  user           User            @relation(fields: [userId], references: [id]) // Relacion con el usuario
  store          Store           @relation(fields: [storeId], references: [id]) // Relacion con la tienda
  client         Client          @relation(fields: [clientId], references: [id]) // Relacion con el cliente
  salesDetails   SalesDetail[] // Relacion con los detalles de la venta
  invoices       InvoiceSales[] // Relacion con las facturas de venta
  payments       SalePayment[] // Relacion con tabla intermedia
  shippingGuides     ShippingGuide[]
  order              Orders?
  company            Company?           @relation(fields: [companyId], references: [id], onDelete: SetNull)
  sunatTransmissions SunatTransmission[]

  @@index([userId])
  @@index([storeId])
  @@index([clientId])
  @@index([createdAt])
  @@index([source])
  @@index([organizationId, createdAt])
}

model PaymentMethod {
  id          Int      @id @default(autoincrement())
  name        String   @unique // Ejemplo: "Visa", "Yape", "Plin", "Efectivo", "Transferencia"
  description String? // Descripcion opcional del metodo de pago
  isActive    Boolean  @default(true) // Indica si el metodo de pago esta habilitado
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  payments                SalePayment[] // Relacion con tabla intermedia
  cashTransactionPayments CashTransactionPaymentMethod[] // Relacion con la tabla intermedia de transacciones de caja
}

model SalePayment {
  id                Int              @id @default(autoincrement())
  salesId           Int
  companyId       Int
  paymentMethodId   Int
  amount            Float // Monto pagado con ese mÃ©todo
  currency          String           @default("PEN") // Tipo de moneda (e.g., PEN, USD)
  transactionId     String? // ID de transaccion para rastrear pagos digitales
  referenceNote     String? // (opcional) para agregar voucher, observacion, etc.
  sale              Sales            @relation(fields: [salesId], references: [id])
  paymentMethod     PaymentMethod    @relation(fields: [paymentMethodId], references: [id])
  cashTransactionId Int?
  cashTransaction   CashTransaction? @relation(fields: [cashTransactionId], references: [id])

  @@index([salesId])
  @@index([paymentMethodId])
  @@index([cashTransactionId])
}

model SalesDetail {
  id                 Int      @id @default(autoincrement())
  salesId            Int // Relacion con la venta
  companyId       Int
  entryDetailId      Int // Relacion con el detalle de la entrada
  storeOnInventoryId Int // Relacion con el inventario de la tienda
  productId          Int // Producto relacionado
  series             String[] // Arreglo de series
  quantity           Int // Cantidad de productos vendidos
  price              Float // Precio unitario del producto
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  sale             Sales            @relation(fields: [salesId], references: [id], onDelete: Cascade) // Relacion con el modelo Sales
  entryDetail      EntryDetail      @relation(fields: [entryDetailId], references: [id]) // Relacion con el modelo EntryDetail
  storeOnInventory StoreOnInventory @relation(fields: [storeOnInventoryId], references: [id]) // Relacion con el inventario de la tienda

  @@index([salesId])
  @@index([productId])
  @@index([entryDetailId])
  @@index([storeOnInventoryId])
}

model InvoiceSales {
  id              Int       @id @default(autoincrement())
  salesId         Int       @unique // Clave foranea unica para la Relacion 1:1// Relacion con la entrada
  companyId       Int
  serie           String // Serie del comprobante
  nroCorrelativo  String // numero correlativo del comprobante
  tipoComprobante String // numero del comprobante
  tipoMoneda      String? // Tipo de moneda (e.g., PEN, USD)
  total           Float? // Total del comprobante
  fechaEmision    DateTime? // Fecha de emisiÃ³n del comprobante
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  sales Sales @relation(fields: [salesId], references: [id], onDelete: Cascade) // Relacion con Entry
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, tipoComprobante, serie, nroCorrelativo]) // Restriccion unica compuesta
}


model CompanyDocumentSequence {
  id                Int      @id @default(autoincrement())
  companyId         Int
  documentType      String
  serie             String
  nextCorrelative   Int      @default(1)
  correlativeLength Int      @default(3)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, documentType])
}

model InvoiceSample {
  id                Int      @id @default(autoincrement())
  organizationId    Int?
  companyId         Int?
  entryId           Int?
  invoiceTemplateId Int?
  originalFilename  String
  storagePath       String
  mimeType          String?
  fileSize          BigInt?
  sha256            String
  extractionStatus  String   @default("PENDING")
  extractionResult  Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  organization Organization?    @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  company      Company?         @relation(fields: [companyId], references: [id], onDelete: SetNull)
  entry        Entry?           @relation(fields: [entryId], references: [id], onDelete: SetNull)
  template     InvoiceTemplate? @relation("InvoiceTemplateSamples", fields: [invoiceTemplateId], references: [id], onDelete: SetNull)
  logs         InvoiceExtractionLog[]

  @@index([organizationId, companyId])
  @@index([entryId])
  @@index([invoiceTemplateId])
  @@unique([sha256, organizationId], name: "InvoiceSample_hash_org_unique")
}

model InvoiceExtractionLog {
  id        Int      @id @default(autoincrement())
  sampleId  Int
  level     String   @default("INFO")
  message   String
  context   Json?
  createdAt DateTime @default(now())

  sample InvoiceSample @relation(fields: [sampleId], references: [id], onDelete: Cascade)

  @@index([sampleId, level])
}

model Orders {
  id              Int         @id @default(autoincrement())
  code            String      @unique
  salesId         Int?        @unique
  status          OrderStatus @default(PENDING)
  payload         Json?
  shippingName    String
  shippingAddress String
  city            String
  postalCode      String
  phone           String?
  carrierId       String?
  carrierName     String?
  organizationId  Int?
  companyId       Int?
  carrierMode     String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  sale          Sales?          @relation(fields: [salesId], references: [id])
  OrderTracking OrderTracking[]
  organization  Organization?   @relation(fields: [organizationId], references: [id])
  company       Company?       @relation(fields: [companyId], references: [id])

  @@index([salesId])
  @@index([organizationId, createdAt])
  @@index([companyId, createdAt])
}

model OrderTracking {
  id          Int      @id @default(autoincrement())
  orderId     Int
  status      String
  description String
  createdAt   DateTime @default(now())

  order Orders @relation(fields: [orderId], references: [id])

  @@index([orderId])
}

model TipoCambio {
  id             Int           @id @default(autoincrement())
  fecha          DateTime      // Fecha del tipo de cambio
  moneda         String        // Ej: "USD", "EUR", "CLP"
  valor          Float         // Cuanto vale 1 unidad de esa moneda en soles
  createdAt      DateTime      @default(now())
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  organizationId Int?

  entries Entry[] // Relacion con entradas

  @@unique([fecha, moneda, organizationId]) // Evita duplicados por organizaciÃ³n
  @@index([fecha, moneda, organizationId])
}

model CashRegister {
  id             Int                @id @default(autoincrement())
  name           String             @unique
  description    String?
  storeId        Int
  initialBalance Decimal            @default(0.00)
  currentBalance Decimal            @default(0.00)
  status         CashRegisterStatus @default(ACTIVE)
  organizationId Int?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  store        Store             @relation(fields: [storeId], references: [id])
  transactions CashTransaction[]
  closures     CashClosure[]

  @@index([organizationId, storeId])
  @@map("cash_registers")
}

model CashTransaction {
  id                 Int                 @id @default(autoincrement())
  cashRegisterId     Int
  type               CashTransactionType
  amount             Decimal
  description        String?
  clientName         String?
  clientDocument     String?
  clientDocumentType String?
  userId             Int
  organizationId     Int?
  createdAt          DateTime            @default(now())

  cashRegister   CashRegister                   @relation(fields: [cashRegisterId], references: [id])
  paymentMethods CashTransactionPaymentMethod[] // Relacion con la tabla intermedia
  user           User                           @relation(fields: [userId], references: [id])
  salePayments   SalePayment[]

  @@index([organizationId, createdAt])
  @@map("cash_transactions")
}

model CashTransactionPaymentMethod {
  id                Int @id @default(autoincrement())
  cashTransactionId Int
  paymentMethodId   Int // Hacer que el campo sea opcional
  amount            Decimal @default(0.00)

  cashTransaction CashTransaction @relation(fields: [cashTransactionId], references: [id])
  paymentMethod   PaymentMethod   @relation(fields: [paymentMethodId], references: [id]) // Relacion opcional
}

model CashClosure {
  id             Int      @id @default(autoincrement())
  cashRegisterId Int
  userId         Int
  openingBalance Decimal
  closingBalance Decimal
  totalIncome    Decimal
  nextOpeningBalance Decimal?
  notes          String?
  totalExpense   Decimal
  organizationId     Int?
  createdAt      DateTime @default(now())

  cashRegister CashRegister @relation(fields: [cashRegisterId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@index([organizationId, createdAt])
  @@map("cash_closures")
}

// Enums
enum CashRegisterStatus {
  ACTIVE
  CLOSED
}

enum CashTransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum SaleSource {
  POS
  WEB
}

enum OrderStatus {
  PENDING
  COMPLETED
  DENIED
}

model ShippingGuide {
  id             Int      @id @default(autoincrement())
  serie          String
  correlativo    String
  motivoTraslado String
  fechaTraslado  DateTime
  puntoPartida   String
  puntoLlegada   String

  transportistaTipoDocumento   String
  transportistaNumeroDocumento String
  transportistaRazonSocial     String
  transportistaNumeroPlaca     String

  destinatarioTipoDocumento   String
  destinatarioNumeroDocumento String
  destinatarioRazonSocial     String

  xmlName        String?
  zipName        String?
  cdrAceptado    Boolean
  cdrCode        String?
  cdrDescription String?

  ventaId Int? // si esta asociada a una venta
  entryId Int? // si esta asociada a una entrada (traslado)

  createdAt DateTime @default(now())

  sale  Sales? @relation(fields: [ventaId], references: [id])
  entry Entry? @relation(fields: [entryId], references: [id])
}

model Review {
  id        Int      @id @default(autoincrement())
  productId Int
  userId    Int
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product @relation(fields: [productId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([productId, userId])
  @@index([productId])
  @@index([userId])
}

model ChatMessage {
  id        Int       @id @default(autoincrement())
  clientId  Int
  senderId  Int
  text      String
  file      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
  deletedAt DateTime?
  seenAt    DateTime?

  client User @relation("ClientMessages", fields: [clientId], references: [id])
  sender User @relation("SenderMessages", fields: [senderId], references: [id])

  @@index([clientId])
  @@index([senderId])
}

model Favorite {
  id        Int      @id @default(autoincrement())
  userId    Int
  productId Int
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

model NewsletterSubscriber {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  createdAt DateTime @default(now())
}

enum AuditAction {
  CREATED
  UPDATED
  DELETED
  LOGIN
  LOGOUT
  OTHER
}

model AuditLog {
  id             String        @id @default(uuid())
  actorId        Int?
  actorEmail     String?
  entityType     String?
  entityId       String?
  action         AuditAction
  summary        String?
  diff           Json?
  ip             String?
  userAgent      String?
  journalEntryId Int?
  journalEntry   JournalEntry? @relation(fields: [journalEntryId], references: [id])
  organizationId Int?
  companyId      Int?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  company        Company?      @relation(fields: [companyId], references: [id], onDelete: SetNull)
  createdAt      DateTime      @default(now())

  @@index([createdAt])
  @@index([actorId])
  @@index([entityType])
  @@index([action])
  @@index([journalEntryId])
  @@index([organizationId])
  @@index([companyId])
}

enum TemplateVersion {
  V1
  V2
}

enum PublishAdapter {
  LOCAL_STUB
}

model Org {
  id        Int       @id @default(autoincrement())
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  campaigns      Campaign[]
  publishTargets PublishTarget[]

  @@unique([name, deletedAt])
}

model Campaign {
  id        Int       @id @default(autoincrement())
  orgId     Int
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  org       Org        @relation(fields: [orgId], references: [id])
  templates Template[]
  creatives Creative[]
  runs      Run[]

  @@unique([orgId, name, deletedAt])
  @@index([orgId])
}

model Template {
  id         Int             @id @default(autoincrement())
  campaignId Int
  name       String
  version    TemplateVersion
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  deletedAt  DateTime?

  campaign  Campaign   @relation(fields: [campaignId], references: [id])
  creatives Creative[]

  @@unique([campaignId, version, deletedAt])
  @@index([campaignId])
}

model Creative {
  id         Int       @id @default(autoincrement())
  campaignId Int
  templateId Int
  name       String
  data       Json
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  campaign Campaign @relation(fields: [campaignId], references: [id])
  template Template @relation(fields: [templateId], references: [id])
  assets   Asset[]

  @@unique([campaignId, name, deletedAt])
  @@index([campaignId])
  @@index([templateId])
}

model Run {
  id         Int       @id @default(autoincrement())
  campaignId Int
  name       String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  campaign Campaign           @relation(fields: [campaignId], references: [id])
  assets   Asset[]
  logs     PublishTargetLog[]

  @@unique([campaignId, name, deletedAt])
  @@index([campaignId])
}

model Asset {
  id         Int       @id @default(autoincrement())
  runId      Int
  creativeId Int
  uri        String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  run      Run                @relation(fields: [runId], references: [id])
  creative Creative           @relation(fields: [creativeId], references: [id])
  logs     PublishTargetLog[]

  @@unique([runId, uri, deletedAt])
  @@index([runId])
  @@index([creativeId])
}

model PublishTarget {
  id        Int            @id @default(autoincrement())
  orgId     Int
  name      String
  adapter   PublishAdapter
  config    Json
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  deletedAt DateTime?

  org  Org                @relation(fields: [orgId], references: [id])
  logs PublishTargetLog[]

  @@unique([orgId, name, deletedAt])
  @@index([orgId])
}

model PublishTargetLog {
  id              Int       @id @default(autoincrement())
  publishTargetId Int
  assetId         Int
  status          String
  message         String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  publishTarget PublishTarget @relation(fields: [publishTargetId], references: [id])
  asset         Asset         @relation(fields: [assetId], references: [id])
  run           Run?          @relation(fields: [runId], references: [id])
  runId         Int?

  @@unique([publishTargetId, assetId, deletedAt])
  @@index([publishTargetId])
  @@index([assetId])
  @@index([runId])
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum Nature {
  DEBIT
  CREDIT
}

enum JournalType {
  GENERAL
  SALES
  PURCHASE
  CASH
  BANK
}

enum EntryStatus {
  DRAFT
  POSTED
  VOID
}

enum PleType {
  SALES
  PURCHASE
  JOURNAL
}

enum PeriodStatus {
  OPEN
  CLOSED
}

model Account {
  id        Int       @id @default(autoincrement())
  code      String    @unique
  name      String
  parentId  Int?
  parent    Account?  @relation("AccountChildren", fields: [parentId], references: [id])
  children  Account[] @relation("AccountChildren")
  level     Int
  isPosting Boolean   @default(false)
  taxCodes  TaxCode[]
}

model Journal {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entries Entry[]
}

model Period {
  id         Int            @id @default(autoincrement())
  startDate  DateTime
  endDate    DateTime
  status     PeriodStatus   @default(OPEN)
  entries    JournalEntry[]
  pleExports PleExport[]

  @@unique([startDate, endDate])
}

model JournalEntry {
  id          Int         @id @default(autoincrement())
  journalId   Int
  periodId    Int
  date        DateTime
  status      EntryStatus @default(DRAFT)
  description String?
  debitTotal  Decimal     @default(0.00)
  creditTotal Decimal     @default(0.00)

  period    Period         @relation(fields: [periodId], references: [id])
  lines     JournalLine[]
  documents DocumentLink[]
  auditLogs AuditLog[]
  // @@check(name: "balance_check", expression: "debitTotal = creditTotal")

  @@index([journalId])
  @@index([periodId])
}

model JournalLine {
  id          Int     @id @default(autoincrement())
  entryId     Int
  accountId   Int
  taxCodeId   Int?
  description String?
  debit       Decimal @default(0.00)
  credit      Decimal @default(0.00)

  entry   JournalEntry @relation(fields: [entryId], references: [id])
  taxCode TaxCode?     @relation(fields: [taxCodeId], references: [id])
  // @@check(name: "debit_credit_check", expression: "(debit = 0 AND credit > 0) OR (credit = 0 AND debit > 0)")

  @@index([entryId])
  @@index([accountId])
}

model TaxCode {
  id                 Int           @id @default(autoincrement())
  code               String        @unique
  rate               Decimal
  lines              JournalLine[]
  name               String
  sunatTributoCode   String
  sunatOperacionType String
  contraAccountId    Int?
  contraAccount      Account?      @relation(fields: [contraAccountId], references: [id])

  @@index([code])
}

model DocumentLink {
  id          Int     @id @default(autoincrement())
  entryId     Int
  url         String
  description String?

  entry JournalEntry @relation(fields: [entryId], references: [id])

  @@index([entryId])
}

model PleExport {
  id         Int      @id @default(autoincrement())
  periodId   Int
  type       PleType
  fileUrl    String
  exportedAt DateTime @default(now())

  period Period @relation(fields: [periodId], references: [id])

  @@index([periodId])
  @@index([type])
}

model TrialBalanceCache {
  id        Int      @id @default(autoincrement())
  startDate DateTime
  endDate   DateTime
  data      Json
  createdAt DateTime @default(now())
}

enum AccEntryStatus {
  DRAFT
  POSTED
  VOID
}

enum AccPeriodStatus {
  OPEN
  LOCKED
}

model AccPeriod {
  id        Int             @id @default(autoincrement())
  name      String          @unique
  status    AccPeriodStatus @default(OPEN)
  entries   AccEntry[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
}

model AccEntry {
  id          Int            @id @default(autoincrement())
  periodId    Int
  date        DateTime
  status      AccEntryStatus @default(DRAFT)
  totalDebit  Float
  totalCredit Float
  providerId  Int?
  serie       String?
  correlativo String?
  invoiceUrl  String?
  source      String?
  sourceId    Int?
  referenceId String?        @unique
  organizationId Int?
  companyId      Int?
  period      AccPeriod      @relation(fields: [periodId], references: [id])
  provider    Provider?      @relation(fields: [providerId], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  company      Company?      @relation(fields: [companyId], references: [id], onDelete: SetNull)
  lines       AccEntryLine[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@unique([source, sourceId])
  @@index([periodId])
  @@index([providerId])
  @@index([organizationId])
  @@index([organizationId, companyId])
}

model AccEntryLine {
  id          Int      @id @default(autoincrement())
  entryId     Int
  account     String
  description String?
  debit       Float    @default(0)
  credit      Float    @default(0)
  quantity    Float?
  entry       AccEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  @@index([entryId])
}
